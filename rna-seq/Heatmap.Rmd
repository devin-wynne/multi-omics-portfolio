---
title: "Heatmap Figure"
output: html_document
date: "2025-12-24"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(RColorBrewer)
```

# -------------------------------
# Calculate TPM
# -------------------------------
calc_tpm <- function(raw_counts, info) {
  rpk <- raw_counts / (info[rownames(raw_counts), "length"] / 1e3)
  t(t(rpk) / (colSums(rpk) / 1e6))
}
# -------------------------------
# Collapse TPM by group 
# -------------------------------
collapse_tpm_by_group <- function(tpm, group_cols, day_cols) {
  collapsed <- sapply(group_cols, function(g) {
    cols_to_avg <- grep(paste0(g, ".*(", paste(day_cols, collapse="|"), ")"), colnames(tpm))
    rowMeans(tpm[, cols_to_avg, drop=FALSE])
  })
  collapsed
}

# -------------------------------
#Heatmap
# -------------------------------
plot_heatmap <- function(expr_matrix, genes = NULL, cluster_rows = FALSE, cluster_cols = FALSE, scale = "row", palette = "RdBu") {
  if (!is.null(genes)) {
    expr_matrix <- expr_matrix[genes, , drop=FALSE]
  }
  
  pheatmap(
    expr_matrix,
    cluster_cols = cluster_cols,
    cluster_rows = cluster_rows,
    color = colorRampPalette(rev(brewer.pal(5, palette)))(100),
    scale = scale
  )
}
